name: Xcode Cloud Build

# This workflow configuration helps Xcode Cloud find the correct project
# Updated to access headers directly from node_modules

settings:
  xcode:
    project: ios/App/App.xcodeproj
    workspace: ios/App/App.xcworkspace
    scheme: App

# Define the build steps
steps:
  - name: Pre-Build Setup
    run:
      command: |
        # Directory information for debugging
        echo "Current directory: $(pwd)"
        echo "Workspace directory: $CI_WORKSPACE"
        
        # For safety, create directories for header files directly in the Pods directory
        mkdir -p /Volumes/workspace/repository/ios/App/Pods/Headers/Public/CapacitorCordova
        mkdir -p /Volumes/workspace/repository/ios/App/Pods/Headers/Public/Capacitor
        
        # Copy CapacitorCordova header files to Pods directory for redundancy
        for header in node_modules/@capacitor/ios/CapacitorCordova/CapacitorCordova/Classes/Public/*.h; do
          if [ -f "$header" ]; then
            cp "$header" /Volumes/workspace/repository/ios/App/Pods/Headers/Public/CapacitorCordova/
            echo "Copied $(basename $header)"
          fi
        done
        
        # Copy main CapacitorCordova header file
        if [ -f "node_modules/@capacitor/ios/CapacitorCordova/CapacitorCordova/CapacitorCordova.h" ]; then
          cp node_modules/@capacitor/ios/CapacitorCordova/CapacitorCordova/CapacitorCordova.h /Volumes/workspace/repository/ios/App/Pods/Headers/Public/CapacitorCordova/
          echo "Copied CapacitorCordova.h"
        fi
        
        # Copy Capacitor header files to Pods directory for redundancy
        for header in node_modules/@capacitor/ios/Capacitor/Capacitor/*.h; do
          if [ -f "$header" ]; then
            cp "$header" /Volumes/workspace/repository/ios/App/Pods/Headers/Public/Capacitor/
            echo "Copied $(basename $header)"
          fi
        done
        
        # Ensure RevenueCat privacy file exists
        mkdir -p /Volumes/workspace/repository/ios/App/Pods/RevenueCat/Sources
        cp PrivacyInfo.xcprivacy /Volumes/workspace/repository/ios/App/Pods/RevenueCat/Sources/
        echo "Added RevenueCat PrivacyInfo.xcprivacy file"
        
        # Ensure RevenueCat resource bundle files exist
        mkdir -p "/Volumes/workspace/repository/ios/App/Pods/Target Support Files/RevenueCat"
        cp ResourceBundle-RevenueCat-RevenueCat-Info.plist "/Volumes/workspace/repository/ios/App/Pods/Target Support Files/RevenueCat/"
        echo "Added RevenueCat resource bundle info plist"
        
        # Ensure CapacitorCordova privacy file exists
        mkdir -p "/Volumes/workspace/repository/node_modules/@capacitor/ios/CapacitorCordova/CapacitorCordova"
        cp CapacitorCordova-PrivacyInfo.xcprivacy "/Volumes/workspace/repository/node_modules/@capacitor/ios/CapacitorCordova/CapacitorCordova/PrivacyInfo.xcprivacy"
        echo "Added CapacitorCordova privacy file"
        
        # Copy RevenueCat source files
        mkdir -p "/Volumes/workspace/repository/ios/App/Pods/RevenueCat/Sources"
        cp -r revenuecat_sources/Sources/* "/Volumes/workspace/repository/ios/App/Pods/RevenueCat/Sources/"
        echo "Added RevenueCat source files"
      destination: macos

  - name: Build and Archive
    build:
      project: ios/App/App.xcodeproj
      workspace: ios/App/App.xcworkspace
      scheme: App
      destination: 'platform=iOS Simulator,name=iPhone 15'
      xcconfig:
        HEADER_SEARCH_PATHS: "$(inherited) $(SRCROOT)/Pods/Headers/Public/CapacitorCordova $(PODS_ROOT)/Headers/Public/CapacitorCordova $(SRCROOT)/Pods/Headers/Public/Capacitor $(PODS_ROOT)/Headers/Public/Capacitor $(SRCROOT)/../../node_modules/@capacitor/ios/CapacitorCordova/CapacitorCordova/Classes/Public $(SRCROOT)/../../node_modules/@capacitor/ios/CapacitorCordova/CapacitorCordova $(SRCROOT)/../../node_modules/@capacitor/ios/Capacitor/Capacitor"
        OTHER_CFLAGS: "$(inherited) -isystem \"$(PODS_ROOT)/Headers/Public/CapacitorCordova\" -isystem \"$(PODS_ROOT)/Headers/Public/Capacitor\""